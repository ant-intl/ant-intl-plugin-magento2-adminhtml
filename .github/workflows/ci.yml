name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - php-version: 7.4
            phpunit-version: "^9.5"
          - php-version: 8.1
            phpunit-version: "^10.0"
          - php-version: 8.2
            phpunit-version: "^10.0"

    steps:
    - uses: actions/checkout@v4

    - name: Validate composer.json and composer.lock
      run: composer validate --strict

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: bcmath, ctype, curl, dom, gd, hash, iconv, intl, mbstring, openssl, pdo_mysql, simplexml, soap, xsl, zip
        tools: composer:v2
        coverage: xdebug


    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-
    - name: Set up Magento repo authentication
      run: composer config --global http-basic.repo.magento.com ${{ secrets.MAGENTO_PUBLIC_KEY }} ${{ secrets.MAGENTO_PRIVATE_KEY }}

    - name: Add Magento repo
      run: composer config repositories.magento composer https://repo.magento.com/

    - name: Install dependencies
      run: |
        composer config --no-plugins allow-plugins.magento/composer-dependency-version-audit-plugin true
        composer config --no-plugins allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
        composer install --no-interaction --prefer-dist

    # Add a test script to composer.json, for instance: "test": "vendor/bin/phpunit"
    # Docs: https://getcomposer.org/doc/articles/scripts.md

#    - name: Run test suite
#      run: composer run-script test

#    - name: Debug - Check files before setup
#      run: |
#        echo "Files in root directory:"
#        ls -la
#        echo "Checking if composer.json.ci exists:"
#        if [ -f "composer.json.ci" ]; then
#          echo "‚úÖ composer.json.ci found"
#        else
#          echo "‚ùå composer.json.ci not found"
#        fi

#    - name: Setup CI environment
#      run: |
#        composer validate --no-check-all

    - name: Install dependencies
      run: |
        composer install --no-interaction --prefer-dist --optimize-autoloader

    - name: Verify installation
      run: |
        echo "üîç Verifying installation..."
        php -v
        composer show --installed | head -10

    - name: Run PHP Syntax Check
      run: |
        echo "üîç Checking PHP syntax..."
        find . -name "*.php" -not -path "./vendor/*" -not -path "./build/*" -exec php -l {} \;

    - name: Run PHPUnit tests with coverage
      run: |
        echo "üß™ Running Unit Tests with coverage..."
        if [ -f "vendor/bin/phpunit" ]; then
          if [[ '${{ matrix.php-version }}' < '8.0' ]]; then
            CONFIG="phpunit9.xml.dist"
          else
            CONFIG="phpunit10.xml.dist"
          fi
          echo "Using configuration: $CONFIG"
          echo "Command: vendor/bin/phpunit --configuration $CONFIG --coverage-clover=build/coverage/clover.xml --coverage-xml=build/coverage/coverage-xml --log-junit=build/coverage/junit.xml --testdox"
          vendor/bin/phpunit \
            --configuration "$CONFIG" \
            --coverage-clover=build/coverage/clover.xml \
            --coverage-xml=build/coverage/coverage-xml \
            --log-junit=build/coverage/junit.xml \
            --testdox
        else
          echo "PHPUnit not found, skipping tests"
          exit 1
        fi

    - name: Create coverage directory
      run: |
        mkdir -p build/coverage

    - name: Clear PHPUnit cache
      run: |
        if [ -d ".phpunit.cache" ]; then
          rm -rf .phpunit.cache
          echo "‚úÖ Cleared PHPUnit cache"
        fi

    - name: Run PHPUnit tests with coverage
      run: |
        echo "üß™ Running Unit Tests with coverage..."
        if [ -f "vendor/bin/phpunit" ]; then
          if [[ '${{ matrix.php-version }}' < '8.0' ]]; then
            CONFIG="phpunit9.xml.dist"
          else
            CONFIG="phpunit10.xml.dist"
          fi
          echo "Using configuration: $CONFIG"
          echo "Command: vendor/bin/phpunit --configuration $CONFIG --coverage-clover=build/coverage/clover.xml --coverage-xml=build/coverage/coverage-xml --log-junit=build/coverage/junit.xml --testdox"
          vendor/bin/phpunit \
            --configuration "$CONFIG" \
            --coverage-clover=build/coverage/clover.xml \
            --coverage-xml=build/coverage/coverage-xml \
            --log-junit=build/coverage/junit.xml \
            --testdox
        else
          echo "PHPUnit not found, skipping tests"
          exit 1
        fi

    - name: Check test results
      run: |
        echo "üìä Test Results Summary:"
        if [ -f "build/coverage/junit.xml" ]; then
          # Ëß£ÊûêÊµãËØïÁªìÊûú
          TESTS=$(grep -o 'tests="[0-9]*"' build/coverage/junit.xml | grep -o '[0-9]*' || echo "0")
          FAILURES=$(grep -o 'failures="[0-9]*"' build/coverage/junit.xml | grep -o '[0-9]*' || echo "0")
          ERRORS=$(grep -o 'errors="[0-9]*"' build/coverage/junit.xml | grep -o '[0-9]*' || echo "0")
          SKIPPED=$(grep -o 'skipped="[0-9]*"' build/coverage/junit.xml | grep -o '[0-9]*' || echo "0")
        
          echo "Total Tests: $TESTS"
          echo "Failures: $FAILURES"
          echo "Errors: $ERRORS"
          echo "Skipped: $SKIPPED"
        
          # Â¶ÇÊûúÊúâÂ§±Ë¥•ÊàñÈîôËØØÔºåÈÄÄÂá∫
          if [ "$FAILURES" -gt "0" ] || [ "$ERRORS" -gt "0" ]; then
            echo "‚ùå Tests failed with $FAILURES failures and $ERRORS errors"
            exit 1
          else
            echo "‚úÖ All tests passed (with $SKIPPED skipped)"
          fi
        else
          echo "‚ö†Ô∏è No test results found"
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./build/coverage/clover.xml
        directory: ./build/coverage/
        flags: unittests
        name: antom-adminhtml-coverage
        fail_ci_if_error: false
        verbose: true

    - name: Archive coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports-php${{ matrix.php-version }}
        path: |
          build/coverage/
        retention-days: 30

    - name: Archive test logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-logs-php${{ matrix.php-version }}
        path: |
          *.log
          build/
        retention-days: 7

    - name: Basic validation summary
      if: always()
      run: |
        echo "## üéØ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| PHP Version | ${{ matrix.php-version }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Module | Antom Adminhtml |" >> $GITHUB_STEP_SUMMARY
        echo "| PHP Files | $(find . -name '*.php' -not -path './vendor/*' -not -path './build/*' | wc -l) |" >> $GITHUB_STEP_SUMMARY
        echo "| Test Files | $(find Test/ -name '*Test.php' 2>/dev/null | wc -l || echo 0) |" >> $GITHUB_STEP_SUMMARY
        if [ -f "build/coverage/clover.xml" ]; then
          echo "| Coverage Report | Generated ‚úÖ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Coverage Report | Not generated ‚ùå |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
        
        echo ""
        echo "‚úÖ CI validation complete"
        echo "üìä PHP version: ${{ matrix.php-version }}"
        echo "üèóÔ∏è Antom Adminhtml Module"
        echo "üìÅ PHP files: $(find . -name '*.php' -not -path './vendor/*' -not -path './build/*' | wc -l)"
        echo "üìã Test files: $(find Test/ -name '*Test.php' 2>/dev/null | wc -l || echo 0)"
        if [ -f "build/coverage/clover.xml" ]; then
          echo "üìä Coverage report: Generated"
        else
          echo "üìä Coverage report: Not generated"
        fi
        echo "üéØ Status: ${{ job.status }}"
